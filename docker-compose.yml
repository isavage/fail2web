version: '3.8'

services:
  fail2ban:
    image: ${DOCKER_IMAGE:-crazymax/fail2ban:latest}
    container_name: ${CONTAINER_NAME:-fail2ban}
    network_mode: host
    volumes:
      - ./fail2ban/data:/data
      - /var/log:/var/log:ro
      # Add additional log paths here as needed:
      # - /var/log/nginx:/var/log/nginx:ro
      # - /opt/app/logs:/var/log/app:ro
      # - /home/user/custom_logs:/var/log/custom:ro
      # - /var/lib/docker/containers:/var/log/docker:ro
      - fail2ban_data:/var/run/fail2ban  # Create named volume for socket
    extra_hosts:
      - "${EXTRA_HOST}"
    environment:
      - F2B_DB_FILE=/data/db/fail2ban.sqlite3
      - F2B_LOGTARGET=STDOUT
      - TZ=${TZ:-America/New_York}
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped

  fail2web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fail2web  
    networks:
      - fail2web.net
    ports:
      - "5000:5000"
    volumes:
      - ./src/backend:/app/backend
      - ./src/frontend:/app/frontend
      - ./fail2ban/data/jail.d:/data/jail.d:rw  # Mount jail.d for configuration management
      - ./templates:/data/templates:ro  # Mount templates directory
      - ./fail2ban/data:/data/fail2ban:rw  # Mount fail2ban data for direct access
      - fail2ban_data:/var/run/fail2ban  # Mount fail2ban socket directory
    environment:
      - FAIL2WEB_USERNAME=${FAIL2WEB_USERNAME}
      - FAIL2WEB_PASSWORD=${FAIL2WEB_PASSWORD}
      - FAIL2WEB_SECRET_KEY=${FAIL2WEB_SECRET_KEY}
      - TZ=${TZ}
    restart: unless-stopped
    depends_on:
      - fail2ban

networks:
  fail2web.net:
    name: fail2web.net
    driver: bridge
    internal: false

volumes:
  fail2ban_data:  # Named volume for fail2ban socket sharing